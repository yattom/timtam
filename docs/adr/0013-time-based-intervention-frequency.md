# ADR 0013: 会議時間経過による介入頻度とプロンプトの動的変更

- Status: Accepted
- Date: 2025-12-26
- Owners: timtam PoC チーム

## 背景 / Context
会議では、時間を判断基準にしてファシリテーターが介入することがある。特に以下の要件がある:
- 会議の序盤、中盤、終盤で介入の頻度を変えたい
- 会議時間が半分過ぎたところで、残りの時間で何が行えるかを参加者に思考させたい
- 終盤では時間を意識した介入が必要

## 決定 / Decision

### 1. 会議時間のトラッキング
- `meetingsMetadataTable`の`startedAt`フィールドを利用して会議開始時刻を取得
- 環境変数`MEETING_DURATION_MS`でデフォルトの会議時間を設定(デフォルト60分)
- 経過時間の割合を計算し、3つのフェーズに分類

### 2. フェーズ別の介入頻度調整
経過時間の割合に応じてLLM呼び出しのクールダウン時間を動的に変更:

| フェーズ | 経過時間割合 | クールダウン時間 | 意図 |
|---------|------------|----------------|-----|
| 序盤 | 0-33% | 10秒 | 控えめな介入で参加者の自律性を尊重 |
| 中盤 | 33-66% | 5秒 | 通常の介入頻度 |
| 終盤 | 66-100% | 3秒 | 積極的な介入で時間内の完了を支援 |

### 3. 時間コンテキストの提供
LLMへのプロンプトに会議時間の情報を追加:
- 経過時間(分)
- 予定時間(分)
- 残り時間(分)
- フェーズ(序盤/中盤/終盤)

例:
```
【会議時間】経過: 45分 / 予定: 60分 / 残り: 15分 (終盤・時間を意識してください)
```

### 4. 半分経過時の特別介入
経過時間が48-52%の範囲に入った時点で一度だけ、以下の内容で介入:
```
会議時間が半分経過しました。残りX分で何が行えるか、参加者に確認を促してください。
```

### 5. 実装箇所
- `services/orchestrator/worker.ts`に`MeetingTimeTracker`クラスを追加
- `TriggerLLM.judge()`メソッドに時間コンテキストパラメータを追加
- CDKスタックで`MEETINGS_METADATA_TABLE`と`MEETING_DURATION_MS`環境変数を設定
- `meetingsMetadataTable`への読み取り権限を付与

## 影響 / Consequences

### プラス影響
- 会議の進行状況に応じた適切な介入頻度の実現
- 終盤での時間を意識した介入により、会議の時間内完了を支援
- 半分経過時点での明示的な確認により、残り時間の有効活用を促進
- 序盤では控えめにすることで、参加者の自律性を尊重

### マイナス影響
- DynamoDBへの読み取りアクセスが増加(会議ID変更時のみ)
- 会議時間が`MEETING_DURATION_MS`と異なる場合、環境変数の調整が必要

### 今後の拡張性
- UI側から会議時間を設定可能にする
- フェーズごとの介入頻度をカスタマイズ可能にする
- 時間オーバー時の特別な介入を追加

## 代替案 / Alternatives

### 代替案1: 固定のクールダウン時間を維持
- シンプルだが、会議の進行状況に応じた柔軟な対応ができない
- 不採用

### 代替案2: プロンプトのみを変更し、頻度は変えない
- 実装が簡単だが、介入のタイミングが最適化されない
- 不採用

### 代替案3: 会議の残り時間をWebフロントエンドで管理
- フロントエンドとバックエンドの同期が必要になり複雑化
- 不採用

## 参考 / References
- Issue #22: 会議の時間経過によって、介入の頻度やプロンプトを変えたい。
- `services/orchestrator/worker.ts`: メインの実装箇所
- `services/meeting-api/meetingMetadata.ts`: 会議メタデータの管理
