# ADR 0003: コスト方針と最適化

- Status: Accepted
- Date: 2025-12-11
- Updated: 2026-01-13 (コスト問題解決を反映)
- Owners: timtam PoC チーム

## 背景 / Context
リアルタイムASR・LLM・TTS・ストリーミング基盤は従量課金となる。PoC段階では低コストでの反復検証が重要。ユーザー回答では予算/運用は未検討（TBD）。

## 決定 / Decision
- 主要サービスとコストの目安（変動あり、PoC参考）
  - ASR: Chime SDK組み込みのtranscript機能（会議時のみ従量課金）
  - LLM: Bedrock（Claude Haiku中心、短文優先）。大型モデルは明示切替のみ
  - TTS: Amazon Polly Neural（$16/100万文字）
  - 伝送/保管: SQS (ADR-0011) / S3 / CloudWatch は利用量課金
  - インフラ: ECS / Lambda / DynamoDB（現在 <<1USD/日）
- 最適化基本方針
  - 介入のデフォルトはチャットのみ（音声はオプトイン）
  - LLM入出力トークンを抑制（プロンプト圧縮、短文応答、コンテキスト窓の最小化）
  - トリガー検出: ルール優先→必要時のみLLM判定へフォールバック
  - メモリ/RAGは段階導入し、最初はミニマム構成
  - メトリクスで単価/分あたり費用を可視化（CloudWatch+カスタムメトリクス）
- 将来計画
  - Recall.ai への移行を検討中（会議記録サービス、従量課金、固定コストなし）

## 影響 / Consequences
- 品質最適化前は介入が簡潔になりがちだが、反復で改善可能
- 大型モデルの常時利用を避けるため、一部の高度応答が遅延/抑制される

## 代替案 / Alternatives
- 第三者ASR（Deepgram等）で単価・品質比較（ネットワーク遅延・運用要件に留意）
- オープンモデルの自前ホスティング（ECS/EKS+GPU）によるコスト最適化（初期投資と運用負担増）

## 未決事項 / TBD
- 正式予算レンジ、会議時間の想定、月間利用見込み
- ベンダ比較の評価観点（WER、日本語固有語精度、遅延、単価）
- 無償/低額クレジットの活用計画

## 実測コスト問題とその解決 / Actual Cost Issues and Resolution

### Amazon Transcribe Streamingの課金問題（2025-12-17発覚、解決済み）

**問題の概要**:
- **1日あたり約$100の請求が発生**（想定を大幅に超過）
- 当時のアーキテクチャは持続不可能と判断

**根本原因**:

1. **最小課金単位の不一致**
   - 実装: 5秒の音声チャンクをTranscribeに送信
   - Transcribeの課金: **最小課金単位は15秒**
   - 結果: 5秒の音声でも15秒分の料金が発生（**3倍のコスト**）

2. **会議の明示的終了処理の欠如**
   - 多数の会議を同時実行しているが、明示的に終了処理を実行していない
   - Transcribeが無音データを1日中処理し続ける状態が発生
   - 結果: 実際の会議時間の何倍もの課金が発生

3. **Kinesis Data Streams の固定コスト**
   - シャード単位での固定課金
   - 使用量に関わらず一定のコストが発生

**解決策（実施済み）**:

1. **Amazon Transcribe Streaming の完全廃止**
   - Chime SDK組み込みのtranscript機能に完全移行
   - 会議実施時のみの従量課金、固定コストなし
   - ブラウザ側でTranscriptEventを受け取り、API経由でバックエンドに送信

2. **Kinesis Data Streams から SQS への移行（ADR-0011）**
   - SQS FIFO キューに置き換え
   - 従量課金のみ、固定コストなし
   - コスト削減と運用簡素化を同時達成

**解決後のコスト状況**:
- **現在の運用コスト: <<1USD/日**
  - ECS (Orchestrator): わずかな従量課金
  - Lambda: 実行時のみ課金
  - DynamoDB: オンデマンド課金
  - SQS: メッセージ単位の従量課金
  - Chime SDK: 会議時のみ従量課金
- 月間想定: $30/月程度（PoC段階として十分許容範囲）

**教訓**:
- AWSサービスの最小課金単位を事前に確認する重要性
- 固定コストサービス（Kinesis等）は小規模PoCには不向き
- 従量課金サービス（SQS、Chime SDK transcript等）の活用でコスト最適化

## 参考 / References
- 各サービスの最新料金ページ（地域別）
- [Amazon Transcribe Pricing](https://aws.amazon.com/transcribe/pricing/) - 最小課金単位15秒の記載確認
