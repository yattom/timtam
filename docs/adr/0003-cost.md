# ADR 0003: コスト方針と最適化

- Status: Proposed
- Date: 2025-12-11
- Owners: timtam PoC チーム

## 背景 / Context
リアルタイムASR・LLM・TTS・ストリーミング基盤は従量課金となる。PoC段階では低コストでの反復検証が重要。ユーザー回答では予算/運用は未検討（TBD）。

## 決定 / Decision
- 主要サービスとコストの目安（変動あり、PoC参考）
  - ASR: Amazon Transcribe Streaming（~$0.015/分/チャネル想定）
  - LLM: Bedrock（Claude 3.7 Haiku中心、短文優先）。大型モデルは明示切替のみ
  - TTS: Amazon Polly Neural（$16/100万文字）
  - 伝送/保管: Kinesis/S3/CloudWatch は利用量課金
- 最適化基本方針
  - 介入のデフォルトはチャットのみ（音声はオプトイン）
  - LLM入出力トークンを抑制（プロンプト圧縮、短文応答、コンテキスト窓の最小化）
  - トリガー検出: ルール優先→必要時のみLLM判定へフォールバック
  - メモリ/RAGは段階導入し、最初はミニマム構成
  - メトリクスで単価/分あたり費用を可視化（CloudWatch+カスタムメトリクス）

## 影響 / Consequences
- 品質最適化前は介入が簡潔になりがちだが、反復で改善可能
- 大型モデルの常時利用を避けるため、一部の高度応答が遅延/抑制される

## 代替案 / Alternatives
- 第三者ASR（Deepgram等）で単価・品質比較（ネットワーク遅延・運用要件に留意）
- オープンモデルの自前ホスティング（ECS/EKS+GPU）によるコスト最適化（初期投資と運用負担増）

## 未決事項 / TBD
- 正式予算レンジ、会議時間の想定、月間利用見込み
- ベンダ比較の評価観点（WER、日本語固有語精度、遅延、単価）
- 無償/低額クレジットの活用計画

## 実測コスト問題 / Actual Cost Issues

### Amazon Transcribe Streamingの課金問題（2025-12-17発覚）

**問題の概要**:
- **1日あたり約$100の請求が発生**（想定を大幅に超過）
- 現在のアーキテクチャは持続不可能と判断

**根本原因**:

1. **最小課金単位の不一致**
   - 実装: 5秒の音声チャンクをTranscribeに送信
   - Transcribeの課金: **最小課金単位は15秒**
   - 結果: 5秒の音声でも15秒分の料金が発生（**3倍のコスト**）

2. **会議の明示的終了処理の欠如**
   - 多数の会議を同時実行しているが、明示的に終了処理を実行していない
   - Transcribeが無音データを1日中処理し続ける状態が発生
   - 結果: 実際の会議時間の何倍もの課金が発生

**影響**:
- 月間コスト想定: $100/日 × 30日 = **$3,000/月**（PoC段階として非現実的）
- 特にバッチモード（Transcribe Batch）で顕著にコスト増加

**緊急対応が必要な事項**:
1. 会議終了時の明示的なTranscribeセッション停止処理の実装
2. 音声チャンクサイズの見直し（5秒 → 15秒以上に変更を検討）
3. 無音検出による自動停止機構の導入
4. コスト監視アラートの設定（日次予算超過時の通知）

**代替案の再検討**:
- Deepgram/AssemblyAI等の他ASRサービスの課金体系比較が急務
- リアルタイム処理の必要性再評価（バッファリングによる最適化の可能性）
- オンデマンド起動/停止の厳格な実装

**関連ADR**:
- ADR 0002: リアルタイム性（ASR部分の見直しが必要）
- ADR 0008: Chime Media Pipelinesでの文字起こし（コスト最適化の観点から再評価必要）

## 参考 / References
- 各サービスの最新料金ページ（地域別）
- [Amazon Transcribe Pricing](https://aws.amazon.com/transcribe/pricing/) - 最小課金単位15秒の記載確認
