# ADR 0010: オーケストレーター時系列メモのインメモリストレージ採用

- Status: Proposed
- Date: 2025-12-23
- Owners: timtam PoC チーム

## 背景 / Context

マルチLLMオーケストレーションシステム（Issue #12, PR #13）では、複数のLLMプロンプト間で時系列メモ（Temporal Notes）を共有する必要がある。このメモは会議中のファシリテーション判断（抽象度レベル、介入カウント、閾値判定など）に使用される揮発性データである。

PR #13のレビューにおいて、高可用性とスケーラビリティの観点からRedis/ElastiCacheの採用が強く推奨されたが、本ADRではインメモリストレージを採用する理由を明確化する。

## 決定 / Decision

時系列メモストレージとして**プロセス内メモリ（Map<meetingId, Map<key, value>>）を採用する**。

### 実装方針
- **保存場所**: オーケストレーターワーカープロセス内メモリ
- **データ構造**: `TemporalNotesStore` クラス（TypeScript Map）
- **スコープ**: 会議単位（meetingId をキーとする）
- **TTL**: 会議終了後1時間でクリーンアップ
- **永続化**: なし（揮発性）
- **バックアップ**: DynamoDB executions テーブルへの変更履歴ログ（オプション）

## 理由 / Rationale

### 1. データのスコープと寿命が限定的
- **単一会議セッション内でのみ有効**: メモは会議開始から終了までの間のみ意味を持つ
- **会議間でのデータ共有不要**: 各会議は独立しており、他の会議のメモを参照する必要がない
- **短命データ**: 会議終了後は不要になる一時的なワークスペース

### 2. データ量の制約
- **小規模データ**: 典型的な会議（1時間）での想定メモサイズは数MB～数十MB程度
  - 例: 時系列の文字起こし＋都度のLLMの出力＋メモの最新版と履歴、など
- **バウンド可能**: YAMLスキーマでメモのサイズ制限を強制可能（例: 各値10KB以下）
- **メモリ効率**: 同時進行会議数は数件程度を想定

### 3. レイテンシとシンプルさの優先
- **超低レイテンシ**: プロセス内メモリアクセスは<1ms、Redis/ElastiCacheは数ms～数十ms
- **ネットワークホップ不要**: ノード実行のクリティカルパスにネットワークI/Oが入らない
- **シンプルな実装**: 外部依存なし、セットアップ・運用・デバッグが容易

### 4. コスト効率
- **追加コストゼロ**: Redis/ElastiCacheは月額$15～$50+のコスト増
- **PoC段階での最適化**: 現時点では不要な複雑性とコストを避ける
- **ADR 0003との整合**: コスト最適化方針に合致

### 5. ECSアーキテクチャとの整合性
- **1ミーティング → 1プロセス**: SQS FIFOのMessageGroupId機構により、各ミーティングは特定のオーケストレータープロセスに割り当てられる（ADR 0011参照）
- **プロセス内で状態管理**: 同一ミーティングのすべてのイベントが同じプロセスで処理されるため、プロセス内メモリで状態を保持できる
- **水平スケーリング可能**: 複数のECSタスクが並行稼働し、それぞれが異なるミーティングを処理可能
- **ステートフルワーカー設計**: オーケストレーターは元々ステートフルなワーカー設計

## 高可用性への対処 / High Availability Considerations

Redis/ElastiCacheの主な利点である「高可用性」については、以下の戦略で対処する:

### 1. メモ変更履歴のロギング
- ElastiCacheにメモの最新版を記録
- タスク障害時、最新の記録から部分的なメモ復元が可能
- 完全な復元は保証しないが、重要な判断履歴は保持

### 2. ECSヘルスチェックと自動復旧
- ECSのヘルスチェック機能で異常検知とタスク自動再起動
- 大半の会議はタスク再起動前に終了するため、影響は限定的

### 3. グレースフルシャットダウン
- デプロイ時のSIGTERM受信時、進行中の会議を完了させてからシャットダウン
- 新規会議の受付停止 + 既存会議の完了待機（タイムアウト付き）

### 4. 将来的な移行パス
- データ量増加や可用性要件の変化があれば、Redis/ElastiCacheへの移行は可能
- インターフェース（`TemporalNotesStore`）を抽象化し、実装の切り替えを容易に

## 影響 / Consequences

### ポジティブ
- ✅ 実装がシンプルで理解しやすい
- ✅ レイテンシが最小（ファシリテーション応答性の向上）
- ✅ 運用コストゼロ（インフラ追加不要）
- ✅ デバッグが容易（外部サービスの障害切り分け不要）

### ネガティブ
- ❌ タスク再起動時にそのタスクが処理中の会議のメモが消失（会議中断のリスク）
- ❌ メモの永続化なし（長期分析には別途ログが必要）

### リスク軽減策
- DynamoDB executions テーブルへの変更履歴ログで、重要データの可視性を確保
- CloudWatch メトリクス（タスク再起動頻度）で監視し、問題の早期検知
- 会議終了後のメモアーカイブ機能（Phase 7以降で検討）

## 代替案 / Alternatives

### 代替案1: Redis/ElastiCache採用（レビューの推奨案）
- **利点**:
  - 高可用性（Multi-AZ）
  - タスク再起動時のメモ復元が可能
  - 永続化オプション（スナップショット）
- **欠点**:
  - 月額$15～$50+のコスト増
  - ネットワークレイテンシ（数ms～数十ms）
  - インフラ複雑化（セットアップ、運用、監視）
  - 現時点では過剰な設計（YAGNI: You Aren't Gonna Need It）
- **判断**: PoC段階では不採用、必要性が明確になった時点で再検討

### 代替案2: DynamoDB直接利用
- **利点**:
  - 既存インフラ活用（追加コストなし）
  - 永続化とTTL自動削除
- **欠点**:
  - レイテンシが高い（数十ms～数百ms）
  - ノード実行毎の読み書きでコスト増（特に高頻度更新）
  - トランザクション制約（複数メモの原子的更新が困難）
- **判断**: レイテンシ要件を満たさないため不採用

### 代替案3: ハイブリッド（メモリ + 定期バックアップ）
- **利点**:
  - メモリの低レイテンシとRedisの永続性の中間
  - DynamoDBへの定期スナップショット（例: 10秒毎）
- **欠点**:
  - 実装複雑化（バックアップタイミング、復元ロジック）
  - 最大10秒分のデータロスリスク
- **判断**: 将来的な選択肢として保留（まず最もシンプルな案から開始）

## 未決事項 / TBD

- メモの最大サイズ制限の具体値（提案: 各値10KB、会議全体で1MB）
- executions テーブルへのログ頻度（全変更 vs. 重要イベントのみ）
- 会議終了後のメモアーカイブ機能の要否（長期分析用途）
- 本番運用後の可用性メトリクス（タスク再起動頻度、会議中断率）を基にした再評価時期

## 再評価トリガー / Re-evaluation Triggers

以下の状況が発生した場合、Redis/ElastiCacheへの移行を再検討する:

1. **タスク再起動による会議中断が月1回以上発生**
2. **同時進行会議数が100を超える見込み**（メモリ使用量の懸念）
3. **単一ミーティングの処理負荷が高く、レイテンシが10秒を超える事例が頻発**（処理最適化の必要性）
4. **会議間でのメモ共有・分析機能の要求が明確化**

## 参考 / References

- [ADR 0003: コスト方針と最適化](./0003-cost.md) - コスト最適化基本方針
- [PR #13: マルチLLMオーケストレーション実装](https://github.com/yattom/timtam/pull/13)
- [Issue #12: 複数のLLMプロンプトを連携させた動的なファシリテーション機能](https://github.com/yattom/timtam/issues/12)
- YAGNI (You Aren't Gonna Need It) - Agile開発原則
